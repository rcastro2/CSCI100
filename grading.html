<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
  	<style>
		  #login, #output, #newaccount, #signupmessage, #loginmessage{display: none;}
		  .btn,#signup{cursor:pointer;}
		  .label{color:white;border-radius:5px;padding:0 4px 0 4px;width:25px;display:inline-block;text-align: center;margin:0 2px 0 2px; box-shadow:black 1px 1px 1px}
		  .P{background-color:blue;}
		  .Q{background-color:darkgreen;}
		  .A{background-color:rgb(130, 0, 0);}
	</style>
  </head>
  <body>
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<a class="navbar-brand" href="index.html">CSCI-100</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item">
				<a class="nav-link" href="syllabus.html">Syllabus</a>
				</li>
				<li class="nav-item">
				<a class="nav-link" href="content.html">Outline</a>
				</li>		  
				<li class="nav-item">
				<a class="nav-link" href="grading.html">Grades</a>
				</li>
			</ul>
			<ul class="navbar-nav navbar-right">
				<li class="nav-item">
				<a class="nav-link" href="contact.html">Contact</a>
				</li>
			</ul>
			</div>
		</nav>
		<div class="jumbotron rounded-0">
			<h1 class="display-4 text-center">Grades</h1>
		</div>
		<div class="container" style="width:300px" id="login">
			<div id="loginmessage" class="alert alert-danger" role="alert"></div>
			<input type="email" id="inputEmail" class="form-control" placeholder="Enter email"  autofocus >
			<input type="password" id="inputPassword" class="form-control" placeholder="Enter password" >
			<button class="btn btn-lg btn-primary btn-block" id="signin">Sign in</button><br>
			<div id="signup" class="text-center">Sign up?</div>
		</div>		
		<div class="container" style="width:300px" id="newaccount">
			<input type="text" id="inputLast" class="form-control" placeholder="Enter last name"  autofocus >
			<input type="text" id="inputFirst" class="form-control" placeholder="Enter first name"  >
			<input type="email" id="newEmail" class="form-control" placeholder="Enter email"  >
			<input type="password" id="newPassword" class="form-control" placeholder="Enter password" >
			<input type="password" id="confirmPassword" class="form-control" placeholder="Confirm password" >
			<button class="btn btn-lg btn-primary btn-block" id="createaccount">Sign up</button><br>
			<div id="signupmessage" class="alert alert-danger" role="alert"></div>
		</div>

		<div id="output" class="container">
			<h1 class="display-6" id="user"></h1>
			<!-- Nav tabs -->
			<ul class="nav nav-tabs" id="myTab" role="tablist">
				<li class="nav-item">
				<a class="nav-link active" data-toggle="tab" href="#overall" role="tab">Overall</a>
				</li>
				<li class="nav-item">
				<a class="nav-link" data-toggle="tab" href="#detailstab" role="tab">Details</a>
				</li>
				<li class="nav-item">
					<a	class="btn btn-primary ml-3" id="signout" role="button" style="color:white;">Sign Out</a>
				</li>
			</ul>
			
			<!-- Tab panes -->
			<div class="tab-content container mt-2">
				<div class="tab-pane active" id="overall" role="tabpanel">
					<div class="card">
						<div class="card-header">
							Major Assessments
						</div>
						<div class="card-body">
							<p><b>Final:</b> <span id="final"></span></p>
							<p><b>Midterm:</b> <span id="midterm"></span></p>
							<p><b>Project:</b> <span id="project"></span></p>
						</div>
					</div>
					<hr>
					<div class="card">
						<div class="card-header">
							Minor Assessments
						</div>
						<div class="card-body">
							<p><b>Quizzes:</b> <span id="quizzes"></span></p>
							<p><b>Assignments:</b> <span id="assignments"></span></p>
							<p><b>Participation:</b> <span id="participation"></span></p>
						</div>
					</div>

				</div>
				<div class="tab-pane" id="detailstab" role="tabpanel">
						<table class="table">
								<caption style="caption-side:top"><b class="label P">&nbsp;</b> Participation <b class="label Q">&nbsp;</b> Quizzes <b class="label A">&nbsp;</b> Assignments</caption>
								<thead class="thead-inverse">
									<tr>
										<th>Class</th>
										<th>Date</th>
										<th>Details</th>
										<th>Description</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<th scope="row">1</th>
										<td id="week1"></td>
										<td id="week1d"></td>
										<td id="week1topic"></td>
									</tr>
									<tr>
										<th scope="row">2</th>
										<td id="week2"></td>
										<td id="week2d"></td>
										<td id="week2topic"></td>
									</tr>
									<tr>
										<th scope="row">3</th>
										<td id="week3"></td>
										<td id="week3d"></td>
										<td id="week3topic"></td>
									</tr>
									<tr>
										<th scope="row">4</th>
										<td id="week4"></td>
										<td id="week4d"></td>
										<td id="week4topic"></td>
									</tr>
									<tr>
										<th scope="row">5</th>
										<td id="week5"></td>
										<td id="week5d"></td>
										<td id="week5topic"></td>
									</tr>
									<tr>
										<th scope="row">6</th>
										<td id="week6"></td>
										<td id="week6d"></td>
										<td id="week6topic"></td>
									</tr>
									<tr class="table-info">
										<th scope="row">7</th>
										<td id="week7"></td>
										<td id="week7d"></td>
										<td id="week7topic"></td>
									</tr>
									<tr>
										<th scope="row">8</th>
										<td id="week8"></td>
										<td id="week8d"></td>
										<td id="week8topic"></td>
									</tr>
									<tr>
										<th scope="row">9</th>
										<td id="week9"></td>
										<td id="week9d"></td>
										<td id="week9topic"></td>
									</tr>
									<tr>
										<th scope="row">10</th>
										<td id="week10"></td>
										<td id="week10d"></td>
										<td id="week10topic"></td>
									</tr>
									<tr>
										<th scope="row">11</th>
										<td id="week11"></td>
										<td id="week11d"></td>
										<td id="week11topic"></td>
									</tr>
									<tr>
										<th scope="row">12</th>
										<td id="week12"></td>
										<td id="week12d"></td>
										<td id="week12topic"></td>
									</tr>
									<tr class="table-info">
										<th scope="row">13</th>
										<td id="week13"></td>
										<td id="week13d"></td>
										<td id="week13topic"></td>
									</tr>
									<tr>
										<th scope="row">14</th>
										<td id="week14"></td>
										<td id="week14d"></td>
										<td id="week14topic"></td>
									</tr>
									<tr class="table-primary">
										<th scope="row">15</th>
										<td id="week15"></td>
										<td id="week15d"></td>
										<td id="week15topic"></td>
									</tr>
								</tbody>
							</table>
				</div>
			</div>
		</div>
		<!-- Optional JavaScript -->
		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
		<script src="https://www.gstatic.com/firebasejs/4.3.0/firebase.js"></script>
		<script>
				// Initialize Firebase
				var info;
				$(document).ready(function(){
					var classes = [{date:"Jan 31",topic:"Course Introduction; Numerical representation of information"},
									{date:"Feb 7",topic:"Introduction to environment; Output of information"},
									{date:"Feb 14",topic:"Variables, Decisions, Enabling Intelligence (1/2)"},
									{date:"Feb 21",topic:"Variables, Decisions, Enabling Intelligence (2/2)"},
									{date:"Feb 28",topic:"Iteration of a process; Representing information as a collection (1/2)"},
									{date:"Mar 7",topic:"Iteration of a process; Representing information as a collection (2/2)"},
									{date:"Mar 14",topic:"Midterm; Discussion of course project"},
									{date:"Mar 21",topic:"External motors and sensors"},
									{date:"Mar 28",topic:"Encapsulate a process; Design thinking"},
									{date:"Apr 18",topic:"Course Project - Team Formation / Idea Selection"},
									{date:"Apr 25",topic:"Course Project - Implementation (Draft)"},
									{date:"May 2",topic:"Course Project - Implementation (Refinement), Presentation Prep"},
									{date:"May 9",topic:"Course Project - Presentation"},
									{date:"May 16",topic:"Raspberry Pi / Course Review"},
									{date:"May 23",topic:"Final"}];
					var semester = "SP18";
					var config = {
						apiKey: "AIzaSyDtNS2b6kDq1r8Du4b7euNQBeyG35IzkJs",
						authDomain: "castro-csci100.firebaseapp.com",
						databaseURL: "https://castro-csci100.firebaseio.com",
						projectId: "castro-csci100",
						storageBucket: "castro-csci100.appspot.com",
						messagingSenderId: "608175833729"
					};
					firebase.initializeApp(config);
					$("#signin").click(function(){
							var email = $("#inputEmail").val();
							var password = $("#inputPassword").val();
							firebase.auth().signInWithEmailAndPassword(email, password).then(function(){
								$("#inputEmail").val("");
								$("#inputPassword").val("");
							}).catch(function(error){
								// Handle Errors here.
								var errorCode = error.code;
								var errorMessage = error.message;
								document.getElementById("loginmessage").style.display = "block";
								$("#loginmessage").html("Login failed.  Please check your username and password.");
								console.log("Error signing in:\n" + errorMessage);
							});
					});
					$("#signout").click(function(){
						firebase.auth().signOut().then(function() {
							hideall();
							document.getElementById("login").style.display = "block";
						}).catch(function(error) {
							var errorCode = error.code;
							var errorMessage = error.message;
							console.log("Error signing out:\n" + errorMessage);
						});
					});
					$("#signup").click(function(){
						hideall();
						document.getElementById("newaccount").style.display = "block";
					});
					$("#createaccount").click(function(){
						var email = $("#newEmail").val();
						var password = $("#newPassword").val();
						var confirmPassword = $("#confirmPassword").val();
						var first = $("#inputFirst").val().toCapitalize();
						var last = $("#inputLast").val().toCapitalize();

						if (!(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(email))){
							document.getElementById("signupmessage").style.display = "block";
							$("#signupmessage").html("You must provide a valid email.");
							return;
						}
						if(!(password === confirmPassword)){
							document.getElementById("signupmessage").style.display = "block";
							$("#signupmessage").html("Confirm password does not match.");
							return;
						}

						//Create the user
						firebase.auth().createUserWithEmailAndPassword(email, password).then(function(user){
								var meetings = {};
								for(var i = 0;i<classes.length;i++){
									var key = classes[i].date.replace(" ","");
									meetings[key] = "";
								}

								user.updateProfile({
									displayName: first + " " + last,
								}).then(function() {
											// Once the Profile is updated create the user in the Database
											var db = firebase.database().ref(semester + "/" + user.uid);
											db.set({
												user: first + " " + last,
												semester:semester,
												finalexam:"",midterm:"",project:"",grades:meetings
											});
											location.reload();
										}, function(error) {
										// Error updating profile
								});					
						}).catch(function(error) {
								// Error creating user
								var errorCode = error.code;
								var errorMessage = error.message;
								$("#signupmessage").html("Error signing up:\n" + errorMessage);
								console.log("Error signing up:\n" + errorMessage);
								// ...
						});
					});
					firebase.auth().onAuthStateChanged(function(user) {
						if (user) {
							// User is signed in.
							var userDB = firebase.database().ref(semester + "/" + user.uid);
							userDB.on('value', function(snapshot) {
								hideall();
								document.getElementById("output").style.display = "block";
								data = snapshot.val();
								$("#user").html(user.displayName);
								$("#final").html(data.finalexam);
								$("#midterm").html(data.midterm);
								$("#project").html(data.project);
								var pct = 0, qct=0,qsum=0,act=0,asum=0, build;
								//Create a mapping between keys and ids
								var meetings = {};
								for(var i = 0;i<classes.length;i++){
									var key = classes[i].date.replace(" ","");
									
									meetings[key] = "#week" + (i + 1) + "d";
								}
								
								for(var key in data.grades){
									build = "&nbsp;"
									var grade = data.grades[key].split(',');
									
									
									if(grade.length > 0 && grade[0].toLowerCase() === "p"){
										pct++;
										build += "<b class='label P'>P</b>";
									}
									if(grade.length > 1 && grade[1] != ""){
										qct++;qsum+=parseFloat(grade[1]);
										build += "<b class='label Q'>" + grade[1] + "</b>";
									}
									if(grade.length > 2 && grade[2] != ""){
										act++;asum+=parseFloat(grade[2]);
										build += "<b class='label A'>" + grade[2] + "</b>";
									}
									$(meetings[key]).html(build);
								}
												
								$("#participation").html(pct + " / 15");	
								if(qct!=0) $("#quizzes").html(qsum/qct * 10 + " %");
								if(act!=0) $("#assignments").html(asum/act * 10 + " %");

							});
						} else {
								// No user is signed in.
								hideall();
								document.getElementById("login").style.display = "block";
						}
					});
					firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);
					var hideall = function(){
						document.getElementById("output").style.display = "none";
						document.getElementById("newaccount").style.display = "none";
						document.getElementById("login").style.display = "none";
						document.getElementById("loginmessage").style.display = "none";
					}
					for(var i = 0; i < classes.length;i++){
						document.getElementById("week"+(i+1)).innerHTML = classes[i].date;
						document.getElementById("week"+(i+1) + "topic").innerHTML = "<b>Topics</b>: " + classes[i].topic;
					}
				})

				String.prototype.toCapitalize = function() {
					s = (this.length < 2) ? this.toUpperCase() : this.substr( 0, 1 ).toUpperCase() + this.substr( 1 ).toLowerCase();
					return s;
				}
				
		</script>
  </body>
</html>