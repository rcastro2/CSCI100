<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
  	<style>
		  #login, #output, #newaccount, #signupmessage, #loginmessage{display: none;}
		  .btn,#signup{cursor:pointer;}
		  .label{color:white;border-radius:5px;padding:0 4px 0 4px;width:25px;display:inline-block;text-align: center;margin:0 2px 0 2px; box-shadow:black 1px 1px 1px}
		  .P{background-color:blue;}
		  .Q{background-color:darkgreen;}
		  .A{background-color:rgb(130, 0, 0);}

		  .slider {
			-webkit-appearance: none;
			width: 30%;
			height: 15px;
			background: #d3d3d3;
			outline: none;
			opacity: 0.7;
			-webkit-transition: .2s;
			transition: opacity .2s;
			margin-left:15px;
			}

			.slider:hover {
			opacity: 1;
			}

			.slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			appearance: none;
			width: 15px;
			height: 15px;
			background: #007bff;
			cursor: pointer;
			}

			.slider::-moz-range-thumb {
			width: 15px;
			height: 15px;
			background: #007bff;
			cursor: pointer;
			}

			.red{color:red;}
			.green {color:green}
			.yellow{color:#cc0}
			.orange{color:orange}
			.red,.green,.yellow,.orange{text-shadow:1px 1px 1px black}
	</style>
  </head>
  <body>
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<a class="navbar-brand" href="index.html">CSCI-100</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item">
				<a class="nav-link" href="syllabus.html">Syllabus</a>
				</li>
				<li class="nav-item">
				<a class="nav-link" href="content.html">Outline</a>
				</li>		  
				<li class="nav-item">
				<a class="nav-link" href="grading.html">Grades</a>
				</li>
			</ul>
			<ul class="navbar-nav navbar-right">
				<li class="nav-item">
				<a class="nav-link" href="contact.html">Contact</a>
				</li>
			</ul>
			</div>
		</nav>
		<div class="jumbotron rounded-0">
			<h1 class="display-4 text-center">Grades</h1>
		</div>
		<div class="container" style="width:300px" id="login">
			<div id="loginmessage" class="alert alert-danger" role="alert"></div>
			<input type="email" id="inputEmail" class="form-control" placeholder="Enter email"  autofocus >
			<input type="password" id="inputPassword" class="form-control" placeholder="Enter password" >
			<button class="btn btn-lg btn-primary btn-block" id="signin">Sign in</button><br>
			<div id="signup" class="text-center">Sign up?</div>
		</div>		
		<div class="container" style="width:300px" id="newaccount">
			<input type="text" id="inputLast" class="form-control" placeholder="Enter last name"  autofocus >
			<input type="text" id="inputFirst" class="form-control" placeholder="Enter first name"  >
			<input type="email" id="newEmail" class="form-control" placeholder="Enter email"  >
			<input type="password" id="newPassword" class="form-control" placeholder="Enter password" >
			<input type="password" id="confirmPassword" class="form-control" placeholder="Confirm password" >
			<button class="btn btn-lg btn-primary btn-block" id="createaccount">Sign up</button><br>
			<div id="signupmessage" class="alert alert-danger" role="alert"></div>
		</div>

		<div id="output" class="container">
			<h1 class="display-6" id="user"></h1>
			<!-- Nav tabs -->
			<ul class="nav nav-tabs" id="myTab" role="tablist">
				<li class="nav-item">
				<a class="nav-link active" data-toggle="tab" href="#overall" role="tab">Overall</a>
				</li>
				<li class="nav-item">
				<a class="nav-link" data-toggle="tab" href="#detailstab" role="tab">Details</a>
				</li>
				<li class="nav-item">
					<a	class="btn btn-primary ml-3" id="signout" role="button" style="color:white;">Sign Out</a>
				</li>
			</ul>
			
			<!-- Tab panes -->
			<div class="tab-content container mt-2">
				<div class="tab-pane active" id="overall" role="tabpanel">
					<div class="card">
						<div class="card-header">
							Overall Grade: 
							<span class="card-body" id="gradeTableContainer">
							
							</span>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-6">
									<h5>Major Assessments</h5>
									<p><b>Final:</b> <span id="final"></span><input value="0" type="range" min="0" max="100" class="slider" id="finalgoal"></p>
									<p><b>Project:</b> <span id="project"></span><input value="0" type="range" min="0" max="100" class="slider" id="projectgoal"></p>
									<p><b>Midterm:</b> <span id="midterm"></span><input value="0" type="range" min="0" max="100" class="slider" id="midtermgoal"></p>
								</div>
								<div class="col-md-6">
									<h5>Minor Assessments</h5>
									<p><b>Quizzes:</b> <span id="quizzes"></span> %</p>
									<p><b>Assignments:</b> <span id="assignments"></span> %</p>
									<p><b>Participation:</b> <span id="participation"></span> / 15 <input type="range" max="15" class="slider" id="participationgoal"></p>
								</div>
							</div>	
						</div>
						<div class="card-footer">
							<a href="https://www.qc.cuny.edu/Academics/SupportPrograms/advising/Academic-and-Grading-Policies/Pages/Default.aspx" target="_blank">Academic and Grading Policies</a>
						</div>
					</div>
				</div>
				<div class="tab-pane" id="detailstab" role="tabpanel">
						<table class="table">
								<caption style="caption-side:top"><b class="label P">&nbsp;</b> Participation <b class="label Q">&nbsp;</b> Quizzes <b class="label A">&nbsp;</b> Assignments</caption>
								<thead class="thead-inverse">
									<tr>
										<th>Class</th>
										<th>Date</th>
										<th>Details</th>
										<th>Description</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
				</div>
			</div>
		</div>
		<!-- Optional JavaScript -->
		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
		<script src="https://www.gstatic.com/firebasejs/4.3.0/firebase.js"></script>
		<script src="syllabus.js"></script>
		<script type="text\template" id="calculationTable">
			<table>
				<th>Assessments</th>
			</table>
		</script>
		<script>
				// Initialize Firebase
				var info;
				$(document).ready(function(){
					var config = {
						apiKey: "AIzaSyDtNS2b6kDq1r8Du4b7euNQBeyG35IzkJs",
						authDomain: "castro-csci100.firebaseapp.com",
						databaseURL: "https://castro-csci100.firebaseio.com",
						projectId: "castro-csci100",
						storageBucket: "castro-csci100.appspot.com",
						messagingSenderId: "608175833729"
					};
					firebase.initializeApp(config);
					$("#signin").click(function(){
							var email = $("#inputEmail").val();
							var password = $("#inputPassword").val();
							firebase.auth().signInWithEmailAndPassword(email, password).then(function(){
								$("#inputEmail").val("");
								$("#inputPassword").val("");
							}).catch(function(error){
								// Handle Errors here.
								var errorCode = error.code;
								var errorMessage = error.message;
								document.getElementById("loginmessage").style.display = "block";
								$("#loginmessage").html("Login failed.  Please check your username and password.");
								console.log("Error signing in:\n" + errorMessage);
							});
					});
					$("#signout").click(function(){
						firebase.auth().signOut().then(function() {
							hideall();
							document.getElementById("login").style.display = "block";
						}).catch(function(error) {
							var errorCode = error.code;
							var errorMessage = error.message;
							console.log("Error signing out:\n" + errorMessage);
						});
					});
					$("#signup").click(function(){
						hideall();
						document.getElementById("newaccount").style.display = "block";
					});
					$("#createaccount").click(function(){
						var email = $("#newEmail").val();
						var password = $("#newPassword").val();
						var confirmPassword = $("#confirmPassword").val();
						var first = $("#inputFirst").val().toCapitalize();
						var last = $("#inputLast").val().toCapitalize();

						if (!(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(email))){
							document.getElementById("signupmessage").style.display = "block";
							$("#signupmessage").html("You must provide a valid email.");
							return;
						}
						if(!(password === confirmPassword)){
							document.getElementById("signupmessage").style.display = "block";
							$("#signupmessage").html("Confirm password does not match.");
							return;
						}

						//Create the user
						firebase.auth().createUserWithEmailAndPassword(email, password).then(function(user){
								var meetings = {};

								for(var i = 0;i<classes[semester].length;i++){
									var key = classes[semester][i].date.replace(" ","");
									meetings[key] = "";
								}
								
								user.updateProfile({
									displayName: first + " " + last,
								}).then(function() {
											// Once the Profile is updated create the user in the Database
											var db = firebase.database().ref(semester + "/" + user.uid);
											db.set({
												user: first + " " + last,
												semester:semester,
												finalexam:"",midterm:"",project:"",grades:meetings
											});
											//location.reload();
										}, function(error) {
										// Error updating profile
								});					
						}).catch(function(error) {
								// Error creating user
								var errorCode = error.code;
								var errorMessage = error.message;
								$("#signupmessage").html("Error signing up:\n" + errorMessage);
								console.log("Error signing up:\n" + errorMessage);
								// ...
						});
					});
					firebase.auth().onAuthStateChanged(function(user) {
						if (user) {
							// User is signed in.
							var userDB = firebase.database().ref(semester + "/" + user.uid);
							userDB.on('value', function(snapshot) {
								hideall();
								document.getElementById("output").style.display = "block";
								data = snapshot.val();
								$("#user").html(user.displayName);
								$("#final").html(data.finalexam);
								$("#midterm").html(data.midterm);
								$("#project").html(data.project);
								if(data.project){
									$("#projectgoal").hide();
								}
								if(data.finalexam){
									$("#finalgoal").hide();
								}
								if(data.midterm){
									$("#midtermgoal").hide();
								}
								var pct = 0, qct=0,qsum=0,act=0,asum=0, build;
								//Create a mapping between keys and ids
								var meetings = {};
								for(var i = 0;i<classes[semester].length;i++){
									var key = classes[semester][i].date.replace(" ","");
									
									meetings[key] = "#week" + (i + 1) + "d";
								}
								
								for(var key in data.grades){
									build = "&nbsp;"
									var grade =  data.grades[key].split(',');
									
									if(grade.length > 0 && grade[0].toLowerCase() === "p"){
										pct++;
										build += "<b class='label P'>P</b>";
									}
									if(grade.length > 1 && grade[1] != ""){
										if(!isNaN(grade[1])){
											qct++;qsum+=parseFloat(grade[1]);
										}
										build += "<b class='label Q'>" + grade[1] + "</b>";
									}
									if(grade.length > 2 && grade[2] != ""){
										if(!isNaN(grade[2])){
											act++;asum+=parseFloat(grade[2]);
										}
										build += "<b class='label A'>" + grade[2] + "</b>";
									}
									$(meetings[key]).html(build);
								}
												
								$("#participation").html(pct);	
								$("#participationgoal").val(pct);
								$("#participationgoal").attr("min",pct);
								if(qct!=0) $("#quizzes").html((qsum/qct * 10).toFixed(2));
								if(act!=0) $("#assignments").html((asum/act * 10).toFixed(2));
								gradeCalculation();

							});
						} else {
								// No user is signed in.
								hideall();
								document.getElementById("login").style.display = "block";
						}
					});
					firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);
					var hideall = function(){
						document.getElementById("output").style.display = "none";
						document.getElementById("newaccount").style.display = "none";
						document.getElementById("login").style.display = "none";
						document.getElementById("loginmessage").style.display = "none";
					}
					$("#finalgoal").change(function(){
						$("#final").html($("#finalgoal").val());
						gradeCalculation();
					})
					$("#projectgoal").change(function(){
						$("#project").html($("#projectgoal").val());
						gradeCalculation();
					})
					$("#participationgoal").change(function(){
						$("#participation").html($("#participationgoal").val());
						gradeCalculation();
					})
					$("#midtermgoal").change(function(){
						$("#midterm").html($("#midtermgoal").val());
						gradeCalculation();
					})
					var gradeCalculation= function(){
						var quiz = $("#quizzes").html(); //15
						var assignments = $("#assignments").html()//15
						var participation = $("#participation").html();//5
						var midterm = $("#midterm").html();//20
						var finalexam = $("#final").html();//30
						var project = $("#project").html();//15
						var numbergrade = finalexam * .30 + midterm * .20 + quiz * .15 + assignments * .15 + project * .15 + (participation/15*100) * .05;

						var lettergrade = letterGradeCalculation(numbergrade);
						var c = "red", status = "GPA in Academic Probation";

						if(numbergrade.isBetween(90,100)) c = "green";
						else if (numbergrade.isBetween(80,90)) c = "orange";
						else if (numbergrade.isBetween(60,80)) c = "yellow";

						if(numbergrade.isBetween(73,100)) status = 'GPA in Good Academic Standing'

						$("#gradeTableContainer").html(`<b class="${c}" >${numbergrade.toFixed(2)}</b> ( ${lettergrade} ) <i class="${c}" > ${status} </i>`);
						
					}
					var build = "";
					for(var i = 0; i < classes[semester].length;i++){
						var topic = classes[semester][i].topic;
						if (topic.includes("Midterm") || topic.includes("Presentation")){
							build += `<tr class="table-info">`
						}else if(topic.includes("Final")){
							build += `<tr class="table-primary">`
						}else{
							build += `<tr>`
						}				
						build += `	<th scope="row">${i+1}</th>`
						build += `	<td id="week${i+1}">${classes[semester][i].date}</td>`
						build += `  <td id="week${i+1}d"</td>`
						build += `	<td id="week${i+1}topic"><b>Topics</b>: ${topic}</td>`
						build += `</tr>`			
					}
					$("tbody").html(build);
				})				
		</script>
  </body>
</html>